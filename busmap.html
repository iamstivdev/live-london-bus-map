<!DOCTYPE html>
<html>
<head>
  <title>Live Bus Map (Google Maps)</title>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1.0">
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
  function initMap() {
    console.log("initMap has been called");

    const london = { lat: 51.5074, lng: -0.1278 };
    const map = new google.maps.Map(document.getElementById('map'), {
      zoom: 13,
      center: london
    });

    const stopCache = {}; // To avoid repeated StopPoint calls

    fetch('https://api.tfl.gov.uk/Line/7/Arrivals')
      .then(res => res.json())
      .then(async data => {
        const buses = {};

        // Group by vehicleId: keep the soonest arrival only
        data.forEach(arrival => {
          const id = arrival.vehicleId;
          if (!buses[id] || new Date(arrival.expectedArrival) < new Date(buses[id].expectedArrival)) {
            buses[id] = arrival;
          }
        });

        console.log(`Showing ${Object.keys(buses).length} buses`);

        for (const bus of Object.values(buses)) {
          const naptanId = bus.naptanId;

          // Use cached stop location if available
          let stop;
          if (stopCache[naptanId]) {
            stop = stopCache[naptanId];
          } else {
            try {
              const res = await fetch(`https://api.tfl.gov.uk/StopPoint/${naptanId}`);
              stop = await res.json();
              stopCache[naptanId] = stop;
            } catch (err) {
              console.warn(`Failed to fetch StopPoint ${naptanId}`);
              continue;
            }
          }

          const lat = stop.lat;
          const lon = stop.lon;

          if (typeof lat !== 'number' || typeof lon !== 'number') {
            console.warn(`Invalid lat/lon for stop ${naptanId}`);
            continue;
          }

          const eta = new Date(bus.expectedArrival).toLocaleTimeString();

          const marker = new google.maps.Marker({
  position: { lat, lng: lon },
  map: map,
  title: `Bus ${bus.vehicleId}`,
  icon: {
    url: "map_bus_2_sml.png", // or your own icon
    scaledSize: new google.maps.Size(20, 30) // resize to fit map cleanly
  }
});


          const infoWindow = new google.maps.InfoWindow({
            content: `<strong>Bus ${bus.vehicleId}</strong><br>To: ${bus.destinationName}<br>Next Stop: ${bus.stationName}<br>ETA: ${eta}`
          });

          marker.addListener('click', () => {
            infoWindow.open(map, marker);
          });
        }
      })
      .catch(err => {
        console.error('TfL API error:', err);
      });
  }
</script>


  <script src="config.js"></script>
  <script>
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap`;
    script.async = true;
    document.head.appendChild(script);
  </script>
</body>
</html>
