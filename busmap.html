<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.6">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 18.0px Helvetica; -webkit-text-stroke: #000000}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 18.0px Helvetica; -webkit-text-stroke: #000000; min-height: 22.0px}
    span.s1 {font-kerning: none}
  </style>
</head>
<body>
<p class="p1"><span class="s1">&lt;!DOCTYPE html&gt;</span></p>
<p class="p1"><span class="s1">&lt;html&gt;</span></p>
<p class="p1"><span class="s1">&lt;head&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;title&gt;Live London Bus Map&lt;/title&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;meta charset="utf-8"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;meta name="viewport" content="initial-scale=1.0"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;style&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>#map {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>height: 100vh;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>width: 100%;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>input#routeInput {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>position: absolute;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>top: 10px;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>left: 10px;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>z-index: 9999;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>padding: 6px;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>font-size: 14px;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;/style&gt;</span></p>
<p class="p1"><span class="s1">&lt;/head&gt;</span></p>
<p class="p1"><span class="s1">&lt;body&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;div id="map"&gt;&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;input type="text" id="routeInput" placeholder="Enter bus route (e.g. 38)" /&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;script src="config.js"&gt;&lt;/script&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;script&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let map;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let markers = [];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let stopCache = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>let currentRoute = "149";</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>function initMap() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>console.log("initMap has been called");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>const london = { lat: 51.5074, lng: -0.1278 };</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>map = new google.maps.Map(document.getElementById("map"), {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>zoom: 13,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>center: london</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>const input = document.getElementById("routeInput");</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>input.value = currentRoute;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>input.addEventListener("change", () =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>currentRoute = input.value.trim();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>stopCache = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>updateBuses();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>updateBuses();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>setInterval(updateBuses, 15000); // Refresh every 15s</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>async function updateBuses() {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>console.log(`Fetching buses for route ${currentRoute}...`);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>markers.forEach(marker =&gt; marker.setMap(null));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>markers = [];</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>try {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const res = await fetch(`https://api.tfl.gov.uk/Line/${currentRoute}/Arrivals`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const data = await res.json();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>console.log("Raw /Arrivals data:", data);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>const buses = {};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>data.forEach(arrival =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>const id = arrival.vehicleId;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (!buses[id] || new Date(arrival.expectedArrival) &lt; new Date(buses[id].expectedArrival)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>buses[id] = arrival;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>console.log(`Showing ${Object.keys(buses).length} vehicles on route ${currentRoute}`);</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>for (const bus of Object.values(buses)) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>const naptanId = bus.naptanId;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>let stop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (stopCache[naptanId]) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>stop = stopCache[naptanId];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>} else {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>const stopRes = await fetch(`https://api.tfl.gov.uk/StopPoint/${naptanId}`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>stop = await stopRes.json();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>stopCache[naptanId] = stop;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>const lat = stop.lat;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>const lon = stop.lon;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>if (!lat || !lon) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>console.warn(`Skipping vehicle ${bus.vehicleId} — invalid coordinates`);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>continue;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>const eta = new Date(bus.expectedArrival).toLocaleTimeString();</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>const marker = new google.maps.Marker({</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>position: { lat, lng: lon },</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>map: map,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>title: `Bus ${bus.vehicleId}`,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>icon: {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>url: "map_bus_2_sml.png", // Use your own icon path here</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">              </span>scaledSize: new google.maps.Size(22, 34)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>const infoWindow = new google.maps.InfoWindow({</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>content: `&lt;strong&gt;Bus ${bus.vehicleId}&lt;/strong&gt;&lt;br&gt;To: ${bus.destinationName}&lt;br&gt;Next Stop: ${bus.stationName}&lt;br&gt;ETA: ${eta}`</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>marker.addListener("click", () =&gt; {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>infoWindow.open(map, marker);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>});</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>markers.push(marker);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>} catch (err) {</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>console.error("Error fetching or processing bus data:", err);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;/script&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;script async</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>src="https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&amp;callback=initMap"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;/script&gt;</span></p>
<p class="p1"><span class="s1">&lt;/body&gt;</span></p>
<p class="p1"><span class="s1">&lt;/html&gt;</span></p>
</body>
</html>
